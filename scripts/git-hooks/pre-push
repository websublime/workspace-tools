#!/usr/bin/env sh
#
# pre-push hook for wnt (Workspace Node Tools)
#
# This hook validates the changeset before allowing a push.
# It ensures the changeset is properly configured and up-to-date.
#
# What it does:
# 1. Detects current branch
# 2. Skips main/master branches
# 3. Validates changeset exists
# 4. Validates changeset is properly formatted
# 5. Blocks push if validation fails
#
# Configuration (.wnt.toml):
# [git_hooks]
# enabled = true
# validate_on_push = true
# strict_validation = false  # true to be more strict
#
# To disable: Set WNT_SKIP_HOOKS=1 environment variable
# Example: WNT_SKIP_HOOKS=1 git push

set -e

# Check if hooks are disabled
if [ -n "${WNT_SKIP_HOOKS}" ]; then
    exit 0
fi

# Colors (only if terminal supports it)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    BOLD=''
    NC=''
fi

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# Skip if not in a git repository
if [ $? -ne 0 ]; then
    exit 0
fi

# Skip for main/master branches
if [ "${BRANCH}" = "main" ] || [ "${BRANCH}" = "master" ]; then
    exit 0
fi

# Check if wnt is installed
if ! command -v wnt >/dev/null 2>&1; then
    printf "${YELLOW}âš ${NC} wnt not found. Skipping changeset validation.\n" >&2
    printf "${BLUE}â„¹${NC} Install: curl -fsSL https://raw.githubusercontent.com/websublime/workspace-node-tools/main/scripts/install.sh | sh\n" >&2
    exit 0
fi

# Display validation message
printf "\n${BLUE}ðŸ” Validating changeset...${NC}\n" >&2

# Run validation
if wnt changeset validate --quiet 2>&1; then
    printf "${GREEN}âœ“${NC} Changeset validation passed\n\n" >&2
    exit 0
fi

# Validation failed
printf "\n${RED}âœ—${NC} ${BOLD}Changeset validation failed${NC}\n\n" >&2

# Get detailed error information
printf "${YELLOW}Validation errors:${NC}\n" >&2
wnt changeset validate 2>&1 | sed 's/^/  /' >&2 || true

printf "\n${BOLD}How to fix:${NC}\n" >&2
printf "  ${GREEN}1.${NC} Check your changeset: ${CYAN}wnt changeset show${NC}\n" >&2
printf "  ${GREEN}2.${NC} Update if needed:     ${CYAN}wnt changeset update${NC}\n" >&2
printf "  ${GREEN}3.${NC} Validate changes:     ${CYAN}wnt changeset validate${NC}\n" >&2
printf "  ${GREEN}4.${NC} Commit and push:      ${CYAN}git commit -m 'chore: update changeset' && git push${NC}\n" >&2

printf "\n${YELLOW}Or create changeset if missing:${NC}\n" >&2
printf "  ${CYAN}wnt changeset create${NC}\n" >&2

printf "\n${BOLD}To skip this check once:${NC}\n" >&2
printf "  ${CYAN}WNT_SKIP_HOOKS=1 git push${NC}\n\n" >&2

exit 1
