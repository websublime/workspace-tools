#!/usr/bin/env sh
#
# pre-push hook for workspace (Workspace Tools)
#
# This hook updates the changeset with all branch commits before pushing.
# It creates a commit with the updated changeset automatically.
#
# What it does:
# 1. Detects current branch
# 2. Skips main/master branches
# 3. Checks if changeset exists (blocks push if missing)
# 4. Adds all branch commits to changeset's changes array (bulk update)
# 5. Creates a commit with the updated changeset file
# 6. Allows push to continue (includes the changeset commit)
#
# Configuration (.workspace.toml):
# [git_hooks]
# enabled = true
# validate_on_push = true
#
# To disable: Set WORKSPACE_SKIP_HOOKS=1 environment variable
# Example: WORKSPACE_SKIP_HOOKS=1 git push

set -e

# Check if hooks are disabled
if [ -n "${WORKSPACE_SKIP_HOOKS}" ]; then
    exit 0
fi

# Colors (only if terminal supports it)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    BOLD='\033[1m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    BOLD=''
    NC=''
fi

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# Skip if not in a git repository
if [ $? -ne 0 ]; then
    exit 0
fi

# Skip for main/master branches
if [ "${BRANCH}" = "main" ] || [ "${BRANCH}" = "master" ]; then
    exit 0
fi

# Check if workspace is installed
if ! command -v workspace >/dev/null 2>&1; then
    printf "${YELLOW}âš ${NC} workspace not found. Skipping changeset validation.\n" >&2
    printf "${BLUE}â„¹${NC} Install: curl -fsSL https://raw.githubusercontent.com/websublime/workspace-tools/main/scripts/install.sh | sh\n" >&2
    exit 0
fi

# Display validation message
printf "\n${BLUE}ðŸ” Checking changeset...${NC}\n" >&2

# Check if changeset exists
if ! workspace changeset show "${BRANCH}" --format quiet >/dev/null 2>&1; then
    # Changeset missing - block push
    printf "\n${RED}âœ—${NC} ${BOLD}No changeset found for branch ${CYAN}${BRANCH}${NC}\n\n" >&2

    printf "${BOLD}How to fix:${NC}\n" >&2
    printf "  ${GREEN}1.${NC} Create changeset:     ${CYAN}workspace changeset create${NC}\n" >&2
    printf "  ${GREEN}2.${NC} Verify it was created: ${CYAN}workspace changeset show ${BRANCH}${NC}\n" >&2
    printf "  ${GREEN}3.${NC} Push again:           ${CYAN}git push${NC}\n" >&2

    printf "\n${BOLD}To skip this check once:${NC}\n" >&2
    printf "  ${CYAN}WORKSPACE_SKIP_HOOKS=1 git push${NC}\n\n" >&2

    exit 1
fi

printf "${GREEN}âœ“${NC} Changeset exists for branch ${CYAN}${BRANCH}${NC}\n" >&2

# Get all commits from this branch that aren't in main
printf "${BLUE}ðŸ“ Adding branch commits to changeset...${NC}\n" >&2

# Determine main branch name
MAIN_BRANCH="main"
if ! git rev-parse --verify main >/dev/null 2>&1; then
    MAIN_BRANCH="master"
fi

# Get commits that are in current branch but not in main
COMMITS=$(git rev-list ${MAIN_BRANCH}..HEAD 2>/dev/null || echo "")

if [ -z "${COMMITS}" ]; then
    printf "${BLUE}â„¹${NC} No commits to add\n" >&2
else
    # Count commits
    COMMIT_COUNT=$(echo "${COMMITS}" | wc -l | tr -d ' ')
    printf "${BLUE}â„¹${NC} Found ${COMMIT_COUNT} commit(s)\n" >&2

    # Add each commit to changeset (suppress "already contains" errors)
    echo "${COMMITS}" | while read -r commit_sha; do
        workspace changeset update "${BRANCH}" --commit "${commit_sha}" --format quiet >/dev/null 2>&1 || true
    done

    printf "${GREEN}âœ“${NC} Commits added to changeset\n" >&2
fi

# Check if changeset was modified
if ! git diff --quiet .changesets/*.json 2>/dev/null; then
    # Changeset was updated - commit it
    printf "${BLUE}ðŸ“¦ Committing updated changeset...${NC}\n" >&2

    git add .changesets/*.json 2>/dev/null || true

    if git commit -m "chore: update changeset for ${BRANCH}" --no-verify >/dev/null 2>&1; then
        printf "${GREEN}âœ“${NC} Changeset committed\n" >&2
    else
        printf "${YELLOW}âš ${NC} Failed to commit changeset (non-fatal)\n" >&2
    fi
else
    printf "${BLUE}â„¹${NC} Changeset already up-to-date\n" >&2
fi

printf "${GREEN}âœ“${NC} Ready to push\n\n" >&2
exit 0
