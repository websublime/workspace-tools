#!/usr/bin/env sh
#
# pre-commit hook for workspace (Workspace Tools)
#
# This hook validates that a changeset exists before allowing a commit.
# It ensures proper changeset workflow is followed for feature branches.
#
# What it does:
# 1. Detects current branch
# 2. Skips main/master branches
# 3. Checks if changeset exists for the branch
# 4. Prompts to create one if missing (or aborts in non-interactive mode)
# 5. Allows commit to proceed if changeset exists
#
# Note: The commit SHA is added to the changeset by the post-commit hook.
#
# Configuration (.workspace.toml):
# [git_hooks]
# enabled = true
# require_changeset = true
#
# To disable: Set WORKSPACE_SKIP_HOOKS=1 environment variable
# Example: WORKSPACE_SKIP_HOOKS=1 git commit -m "message"

set -e

# Check if hooks are disabled
if [ -n "${WORKSPACE_SKIP_HOOKS}" ]; then
    exit 0
fi

# Colors (only if terminal supports it)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    NC=''
fi

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# Skip if not in a git repository
if [ $? -ne 0 ]; then
    exit 0
fi

# Skip for main/master branches
if [ "${BRANCH}" = "main" ] || [ "${BRANCH}" = "master" ]; then
    exit 0
fi

# Check if workspace is installed
if ! command -v workspace >/dev/null 2>&1; then
    printf "${YELLOW}âš ${NC} workspace not found. Changeset not updated.\n" >&2
    printf "${BLUE}â„¹${NC} Install: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/websublime/workspace-tools/releases/latest/download/sublime_cli_tools-installer.sh | sh\n" >&2
    exit 0
fi

# Check if changeset exists for this branch
if workspace changeset show "${BRANCH}" --format quiet >/dev/null 2>&1; then
    # Changeset exists - all good
    printf "${GREEN}âœ“${NC} Changeset found for branch ${BLUE}${BRANCH}${NC}\n" >&2
    exit 0
fi

# No changeset exists - inform user
printf "\n${YELLOW}âš ${NC} No changeset found for branch ${BLUE}${BRANCH}${NC}\n" >&2

# Try to use terminal directly for interactive prompts
# This works even when stdin is redirected (like with git commit -m)
if [ -e /dev/tty ]; then
    exec < /dev/tty

    # Prompt to create changeset
    printf "${YELLOW}?${NC} Create changeset now? ${BLUE}[Y/n]${NC} " >&2
    read -r response

    case "${response}" in
        [nN][oO]|[nN])
            # User declined - ask if they want to continue anyway
            printf "${YELLOW}?${NC} Continue commit without changeset? ${BLUE}[y/N]${NC} " >&2
            read -r continue_response

            case "${continue_response}" in
                [yY][eE][sS]|[yY])
                    printf "${YELLOW}âš ${NC} Proceeding without changeset\n" >&2
                    exit 0
                    ;;
                *)
                    printf "${RED}âœ—${NC} Commit aborted\n" >&2
                    printf "${BLUE}â„¹${NC} Create changeset with: ${GREEN}workspace changeset create${NC}\n" >&2
                    exit 1
                    ;;
            esac
            ;;
        *)
            # User accepted (default) - create changeset interactively
            printf "\n${BLUE}ðŸ“ Creating changeset...${NC}\n\n" >&2

            if workspace changeset create; then
                printf "\n${GREEN}âœ“${NC} Changeset created successfully\n" >&2
                printf "${BLUE}â„¹${NC} Continuing with commit...\n" >&2
                exit 0
            else
                printf "\n${RED}âœ—${NC} Failed to create changeset\n" >&2
                printf "${YELLOW}?${NC} Continue commit anyway? ${BLUE}[y/N]${NC} " >&2
                read -r fallback_response

                case "${fallback_response}" in
                    [yY][eE][sS]|[yY])
                        printf "${YELLOW}âš ${NC} Proceeding without changeset\n" >&2
                        exit 0
                        ;;
                    *)
                        printf "${RED}âœ—${NC} Commit aborted\n" >&2
                        exit 1
                        ;;
                esac
            fi
            ;;
    esac
else
    # No terminal available (CI/CD, scripts, etc.) - warn but allow commit
    printf "${YELLOW}âš ${NC} No terminal available - proceeding without changeset\n" >&2
    printf "${BLUE}â„¹${NC} Create changeset later with: ${GREEN}workspace changeset create${NC}\n" >&2
    exit 0
fi
