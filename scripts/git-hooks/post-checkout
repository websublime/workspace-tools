#!/usr/bin/env sh
#
# post-checkout hook for wnt (Workspace Node Tools)
#
# This hook automatically creates a changeset when you create or checkout
# a new feature branch.
#
# What it does:
# 1. Detects if you checked out a branch (not just files)
# 2. Checks if it's a new feature branch (not main/master)
# 3. Checks if changeset already exists
# 4. If not, prompts to create one (or creates with defaults)
#
# Configuration (.wnt.toml):
# [git_hooks]
# enabled = true
# auto_create_on_checkout = true
# prompt_for_changeset = true  # false for silent creation
#
# To disable: Set WNT_SKIP_HOOKS=1 environment variable
# Example: WNT_SKIP_HOOKS=1 git checkout -b feature/new

set -e

# Check if hooks are disabled
if [ -n "${WNT_SKIP_HOOKS}" ]; then
    exit 0
fi

# Hook arguments
PREV_HEAD=$1
NEW_HEAD=$2
BRANCH_CHECKOUT=$3

# Only run for branch checkouts (not file checkouts)
if [ "${BRANCH_CHECKOUT}" = "0" ]; then
    exit 0
fi

# Colors (only if terminal supports it)
if [ -t 1 ]; then
    RED='\033[0;31m'
    GREEN='\033[0;32m'
    YELLOW='\033[1;33m'
    BLUE='\033[0;34m'
    CYAN='\033[0;36m'
    NC='\033[0m'
else
    RED=''
    GREEN=''
    YELLOW=''
    BLUE=''
    CYAN=''
    NC=''
fi

# Get current branch
BRANCH=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)

# Skip if not in a git repository
if [ $? -ne 0 ]; then
    exit 0
fi

# Skip for main/master branches
if [ "${BRANCH}" = "main" ] || [ "${BRANCH}" = "master" ]; then
    exit 0
fi

# Check if wnt is installed
if ! command -v wnt >/dev/null 2>&1; then
    printf "${YELLOW}âš ${NC} wnt not found. Changeset not created.\n" >&2
    printf "${BLUE}â„¹${NC} Install: curl -fsSL https://raw.githubusercontent.com/websublime/workspace-node-tools/main/scripts/install.sh | sh\n" >&2
    printf "${CYAN}ðŸ’¡${NC} You can create changeset manually: wnt changeset create\n" >&2
    exit 0
fi

# Check if changeset already exists
if wnt changeset show --quiet >/dev/null 2>&1; then
    # Changeset exists, nothing to do
    exit 0
fi

# Check if this is likely a new branch (very few commits ahead of main)
COMMITS_AHEAD=$(git rev-list --count main..HEAD 2>/dev/null || echo "0")

# Only auto-create for new branches (0-2 commits ahead)
if [ "${COMMITS_AHEAD}" -gt 2 ]; then
    # Probably an old branch, don't auto-create
    exit 0
fi

# Display info
printf "\n${BLUE}ðŸ“ New feature branch detected: ${CYAN}%s${NC}\n" "${BRANCH}" >&2
printf "${BLUE}â„¹${NC}  No changeset found for this branch\n\n" >&2

# Check if running in interactive terminal
if [ -t 0 ]; then
    # Interactive mode: prompt user
    printf "${YELLOW}?${NC} Create changeset now? ${CYAN}[Y/n]${NC} " >&2
    read -r response

    case "${response}" in
        [nN][oO]|[nN])
            printf "${BLUE}â„¹${NC} Skipped. Create later with: ${GREEN}wnt changeset create${NC}\n" >&2
            exit 0
            ;;
        *)
            # Create changeset interactively
            printf "\n" >&2
            wnt changeset create || {
                printf "\n${YELLOW}âš ${NC} Failed to create changeset\n" >&2
                printf "${CYAN}ðŸ’¡${NC} Create manually: ${GREEN}wnt changeset create${NC}\n" >&2
                exit 0
            }
            printf "\n${GREEN}âœ“${NC} Changeset created successfully\n" >&2
            ;;
    esac
else
    # Non-interactive mode: create with defaults silently
    printf "${BLUE}â„¹${NC}  Creating changeset with defaults...\n" >&2

    if wnt changeset create --auto --quiet 2>/dev/null; then
        printf "${GREEN}âœ“${NC} Changeset created\n" >&2
    else
        printf "${YELLOW}âš ${NC} Could not auto-create changeset\n" >&2
        printf "${CYAN}ðŸ’¡${NC} Create manually: ${GREEN}wnt changeset create${NC}\n" >&2
    fi
fi

exit 0
